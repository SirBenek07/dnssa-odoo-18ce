<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="project_task_form_stage_dependency" model="ir.ui.view">
        <field name="name">project.task.form.stage.dependency</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='date_deadline']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='stage_id']" position="after">
                <field name="warn_stage_change_ack" invisible="1" />
                <field
                    name="completion_stage_id"
                    optional="hide"
                    groups="project.group_project_manager"
                    domain="[('project_ids', '=', project_id)]"
                />
            </xpath>
            <xpath expr="//field[@name='state']" position="attributes">
                <attribute name="context">{'allow_warn_dependency_close': True}</attribute>
            </xpath>
            <xpath expr="//field[@name='stage_id']" position="attributes">
                <attribute name="invisible" add="parent_id" separator=" or " />
                <attribute name="context">{'allow_warn_stage_change': True}</attribute>
            </xpath>
            <xpath expr="//notebook" position="inside">
                <page
                    string="Dependencias"
                    groups="project.group_project_manager"
                    invisible="not parent_id"
                >
                    <group>
                        <field
                            name="completion_stage_id"
                            string="Etapa obligatoria de cierre"
                            groups="project.group_project_manager"
                            domain="[('project_ids', '=', project_id)]"
                        />
                        <field
                            name="completion_stage_enforcement"
                            groups="project.group_project_manager"
                            invisible="not completion_stage_id"
                        />
                        <field
                            name="dependency_task_ids"
                            widget="many2many_tags"
                            domain="[
                                '&amp;', '&amp;',
                                ('project_id', '=', project_id),
                                ('id', '!=', id),
                                ('family_root_task_id', '=', family_root_task_id)
                            ]"
                            options="{'color_field': 'color'}"
                            context="{'default_project_id': project_id}"
                        />
                        <field
                            name="dependency_enforcement"
                            groups="project.group_project_manager"
                            invisible="not dependency_task_ids"
                        />
                    </group>
                </page>
            </xpath>
        </field>
    </record>
</odoo>
